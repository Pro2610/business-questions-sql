### 1) Build funnel steps per user
```sql
WITH user_events AS (
  SELECT
    user_id,
    MIN(DATE(payment_date)) AS first_payment_date,
    COUNT(*) AS total_payments,
    location,
    software_name,
    `User Type` AS user_type
  FROM `project.dataset.payments`
  GROUP BY 1,4,5,6
)
, funnel AS (
  SELECT
    user_id,
    location,
    software_name,
    user_type,
    1 AS registered,
    CASE WHEN total_payments >= 1 THEN 1 ELSE 0 END AS first_payment,
    CASE WHEN total_payments >= 2 THEN 1 ELSE 0 END AS repeat_payment
  FROM user_events
)
