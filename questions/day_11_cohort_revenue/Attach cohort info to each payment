WITH first_payment AS (
  SELECT
    user_id,
    DATE_TRUNC(MIN(DATE(payment_date)), MONTH) AS cohort_month
  FROM `project.dataset.payments`
  GROUP BY 1
)
, payments_with_cohort AS (
  SELECT
    p.user_id,
    DATE_TRUNC(DATE(p.payment_date), MONTH) AS payment_month,
    fp.cohort_month,
    p.revenue_amount
  FROM `project.dataset.payments` p
  JOIN first_payment fp
    ON p.user_id = fp.user_id
)
