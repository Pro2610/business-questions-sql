SELECT
  DATE_TRUNC(DATE(payment_date), MONTH) AS month,
  location,
  SAFE_DIVIDE(
    COUNT(DISTINCT user_id),
    MAX(COUNT(DISTINCT user_id)) OVER (PARTITION BY DATE_TRUNC(DATE(payment_date), MONTH))
  ) AS segment_activity_ratio
FROM `project.dataset.payments`
GROUP BY 1,2
ORDER BY month, segment_activity_ratio DESC;
