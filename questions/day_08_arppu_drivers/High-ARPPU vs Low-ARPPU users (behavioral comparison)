WITH user_arppu AS (
  SELECT
    user_id,
    SAFE_DIVIDE(
      SUM(revenue_amount),
      COUNT(DISTINCT FORMAT_DATE('%Y-%m', DATE(payment_date)))
    ) AS arppu
  FROM `project.dataset.payments`
  GROUP BY 1
),
thresholds AS (
  SELECT
    APPROX_QUANTILES(arppu, 10)[OFFSET(8)] AS high_threshold,
    APPROX_QUANTILES(arppu, 10)[OFFSET(2)] AS low_threshold
  FROM user_arppu
)
SELECT
  CASE
    WHEN ua.arppu >= t.high_threshold THEN 'High ARPPU'
    WHEN ua.arppu <= t.low_threshold THEN 'Low ARPPU'
  END AS arppu_group,
  COUNT(DISTINCT ua.user_id) AS users,
  AVG(ua.arppu) AS avg_arppu
FROM user_arppu ua
CROSS JOIN thresholds t
WHERE ua.arppu >= t.high_threshold
   OR ua.arppu <= t.low_threshold
GROUP BY 1;

